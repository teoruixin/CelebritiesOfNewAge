<!DOCTYPE html>
<html>
  <meta charset="utf-8" />
  <head>
    <title>Top 8 Categories and the Top 3 YouTubers by Subscribers</title>
    <style>
      h1 {
        font-size: 20px;
        font-family: 'Times New Roman';
        text-align: center;
      }

      svg {
        display: block;
        margin-left: auto;
        margin-right: auto;
      }

      svg text {
        font-size: 11px;
        font-family: sans-serif;
        text-anchor: middle;
        fill: black;
      }

      .legend {
        font-size: 14px;
      }

      .legend-entry {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }

      .legend-color {
        width: 15px;
        height: 15px;
        margin-right: 10px;
        border: 1px solid #000;
      }

      .legend-text {
        flex-grow: 1;
      }

      .legend-container {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.7);
        padding: 10px;
        border: 1px solid #ccc;
      }
    </style>
    <script src="https://d3js.org/d3.v7.min.js" charset="utf-8"></script>
  </head>
  <body>
    <h1>Top 8 Categories and the Top 3 YouTubers by Subscribers</h1>
    <svg class="chart"></svg>
    <div class="legend-container">
      <div class="legend"></div>
    </div>
    <script>
      var chartWidth = 900;
      var chartHeight = 400;

      // Define colors for each category
      var categoryColors = d3.scaleOrdinal(d3.schemeCategory10);

      /******** Data ********/
      var allData;

      /******** Load Data ********/
      var index = 0;
      d3.csv("Global YouTube Statistics.csv", (row, i) => {
        return {
          youtuber: row.Youtuber,
          subscribers: +row.subscribers,
          category: row.category
        };
      }).then(rows => {
        // Filter out rows with the category value "nan"
        rows = rows.filter(row => row.category && row.category.toLowerCase() !== "nan");

        // Group data by category
        var groupedData = d3.group(rows, d => d.category);
        
        // Calculate total subscribers for each category
        var categorySubscribers = new Map();
        groupedData.forEach((group, category) => {
          var totalSubscribers = d3.sum(group, d => d.subscribers);
          categorySubscribers.set(category, totalSubscribers);
        });
        
        // Sort categories by total subscribers in descending order
        var topCategories = Array.from(categorySubscribers)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 8); // Select the top 8 categories

        // Assign colors to the top categories
        topCategories.forEach((category, i) => {
          category[1] = i;
          category[2] = categoryColors(i);
        });

        // Display the legend
        var legend = d3.select(".legend").selectAll(".legend-entry")
          .data(topCategories)
          .enter()
          .append("div")
          .attr("class", "legend-entry");

        legend.append("div")
          .attr("class", "legend-color")
          .style("background-color", (d) => d[2]);

        legend.append("div")
          .attr("class", "legend-text")
          .text((d) => d[0]);
        
        // Extract the top 3 YouTubers for each of the top categories
        var topYoutubers = [];
        topCategories.forEach(([category, totalSubscribers, color]) => {
          var categoryYoutubers = groupedData.get(category);
          categoryYoutubers.sort((a, b) => b.subscribers - a.subscribers);
          categoryYoutubers.forEach(youtuber => youtuber.color = color);
          topYoutubers.push(...categoryYoutubers.slice(0, 3)); // Show top 3 YouTubers in each category
        });
        
        allData = topYoutubers;
        makeChart(topYoutubers);
      }).catch(error => {
        console.log(error);
      });

      /******** Scales ********/
      var x, y;

      /******** Axes ********/
      var xAxis;
      var yAxis;

      /******** Make Chart ********/
      function makeChart(data) {
        // x position
        x = d3.scaleLinear()
          .domain([0, d3.max(data, function (d) { return d.subscribers; })])
          .nice()
          .range([180, chartWidth - 30]);

        // y position
        y = d3.scaleBand()
          .domain(data.map(d => d.youtuber))
          .range([20, chartHeight - 25])
          .padding(0.2);

        var canvas = d3.select(".chart")
          .style("width", chartWidth)
          .style("height", chartHeight)
          .attr("transform", "translate(0," + -10 + ")");

        var bars = d3.select(".chart").selectAll("rect")
          .data(data);

        // ENTER
        var enter = bars.enter().append("rect")
          .attr("x", 180)
          .attr("y", (d) => y(d.youtuber))
          .attr("width", (d) => x(d.subscribers) - 180)
          .attr("height", y.bandwidth())
          .attr("fill", (d) => d.color); // Assign the color based on the category

        // ENTER + UPDATE
        enter.merge(bars)
          .attr("x", 180)
          .attr("y", (d) => y(d.youtuber))
          .attr("width", (d) => x(d.subscribers) - 180)
          .attr("height", y.bandwidth());

        xAxis = d3.axisBottom()
          .scale(x)
          .tickFormat(d => (d / 1000000).toFixed(2) + "M"); // Display subscribers in millions

        yAxis = d3.axisLeft()
          .scale(y);

        var yAxisGroup = canvas.append("g")
          .attr("class", "axis")
          .attr("transform", "translate(180,0)")
          .call(yAxis);

        yAxisGroup.selectAll("text")
          .attr("transform", "translate(-5,0")
          .style("text-anchor", "end");

        yAxisGroup.append("text")
          .text("Youtuber")
          .attr("y", 17)
          .attr("dx", -10)
          .style("text-anchor", "end")
          .style("font-weight", "bold");

        canvas.append("g")
          .attr("class", "axis")
          .attr("transform", "translate(0," + (chartHeight - 25) + ")")
          .call(xAxis)
          .append("text")
          .text("Subscribers")
          .attr("x", chartWidth - 30)
          .attr("dy", -5)
          .style("text-anchor", "end")
          .style("fill", "black")
          .style("font-weight", "bold");

        // Add count labels to the bars
        canvas.selectAll(".count-label")
          .data(data)
          .enter()
          .append("text")
          .attr("class", "count-label")
          .attr("x", (d) => x(d.subscribers) + 5)
          .attr("y", (d) => y(d.youtuber) + y.bandwidth() / 2 + 5)
          .text((d) => (d.subscribers / 1000000).toFixed(2) + "M") // Display subscribers in millions
          .style("font-size", "12px")
          .style("fill", "black")
          .style("text-anchor", "start");
      }
    </script>
  </body>
</html>
